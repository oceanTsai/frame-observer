//author: Sparrow.jang
//verion: 0.1.2
!function(e){var t=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},r=e.document,n=buildDeferred,s={isString:function(e){return"string"==typeof e},isElement:function(e){return e instanceof Element},isObject:function(e){return"object"==typeof e},isArray:function(e){return"[object Array]"==typeof Object.prototype.toString.call(e)},clone:function(e,t,r){var n,i,a,o=this.copyArray(arguments);"boolean"!=typeof e?(n=e,a=o.slice(1)):(n=t,a=o.slice(2));for(var v in a){var i=a[v];for(var f in i)s.isArray(i[f])?n[f]=s.isArray(n[f])?n[f]:[]:s.isObject(i[f])&&(n[f]=s.isObject(n[f])?n[f]:{}),e&&s.isObject(i[f])?clone(n[f],i[f]):n[f]=i[f]}return n},copyArray:function(e){for(var t=[],r=0;r<e.length;r++)t[r]=e[r];return t},createElement:function(e){return r.createElement(e)},DATA_KEY:t(),data:function(e,t,r){var n=this.DATA_KEY,s=e[n]?e[n]:e[n]={};return 3!==arguments.length?s[t]:void(s[t]=r)},getContentWindowByEl:function(e){return s.isElement(e)?e.contentWindow:e}},i={getOrigin:function(e){var t=/https?:\/\/[^/]*\/?/.exec(e);return t.length?t[0]:null},getOriginByFrameEl:function(e){return s.isElement(e)?i.getOrigin(e.src):document.referrer}},a=function(){this.events={}};a.prototype={on:function(e,t,r){var r=r||{};this.events[e]||(this.events[e]=[]),this.events[e].push({func:t,once:r.once||!1,target:r.target||null})},once:function(e,t){this.on(e,t,{once:!0})},off:function(e,t,r){var n=this.events[e]||[];if(1===arguments.length)delete this.events[e];else for(var s in n){var i=n[s];if(i.func===t&&(null===i.target||i.target===r)||void 0===t&&i.target===r){n.splice(s,1);break}}},getEventNumber:function(e){return this.events[e]?this.events[e].length:0},trigger:function(e){var t,r;s.isString(e)?t=e:(t=e.name,r=e.target||null);var n,i=this.events[t]||[],a=s.copyArray(arguments);r&&(i=function(e,t){var r=[];for(var n in e)e[n].target===t&&r.push(e[n]);return r}(i,r));for(n in i){var o={type:t},v=a.slice(1);v.unshift(o),i[n].func.apply(null,v)}for(n=0;n<i.length;n++)i[n].once&&(r?this.off(t,e.func,e.target):this.off(t,e.func))}};var o=function(){this.stateDeferredMap={}};o.prototype={assign:function(e,t){var r=this.get(e);r.done(t.resolve.bind(t)),r.fail(t.reject.bind(t))},get:function(e){var t=this.stateDeferredMap[e];return t?t:this.stateDeferredMap[e]=n()}};var v=function(e,r,n,i,a){var o=n||{},v=i?i:t(),f=a||{};return s.clone({type:e,data:o,id:v,timestamp:+new Date,direction:r},f)},f=function(e,t){return function(r){var a,o,f=n(),u=v(e,"send",{params:s.copyArray(arguments).slice(1)},null,t);return this.evtMapping[u.id]={el:r,id:u.id,deferred:f},a=i.getOriginByFrameEl(r),o=s.getContentWindowByEl(r),o.postMessage(JSON.stringify(u),a),f}},u={deferredSendResp:function(){return function(e){var t="reject",r=this.frameObserver,n=r.evtMapping[e.id];delete r.evtMapping[e.id],"done"===e.deferredState&&(t="resolve"),n.deferred[t](e.data)}},deferredRecv:function(){return function(e,t,r,n){var s=function(n){return function(){var s=v(e.type,"recv",{result:arguments},e.id,{deferredState:n});t.postMessage(JSON.stringify(s),r)}};n.done(s("done")),n.fail(s("fail"))}}},c=function(e){this.frameObserver=e};c.prototype={onRecv:function(e,t,r,n){var s=this.frameObserver,i=e.data.params,a=i.shift();i.unshift(n),s.methods_&&s.methods_[a]?s.methods_[a].apply(s.methods_,i):n.reject({err:"the method is not exist."}),u.deferredRecv().apply(this,arguments)},onSendResp:u.deferredSendResp()};var d=function(e){this.frameObserver=e};d.prototype={onRecv:function(e,t,r,n){var i=e.data.params[0],a=this.frameObserver,o=i.eventName,f=i.frameEventId;a.registerEventObserver.on(o,function(){var n=v("event","send",{result:s.copyArray(arguments)},e.id);n.frameEventId=f,t.postMessage(JSON.stringify(n),r)},{target:t})},onSendResp:function(e){}};var g=function(e){this.frameObserver=e};g.prototype={onRecv:function(e,t,r,n){{var s=e.data.params[0],i=this.frameObserver,a=s.eventName;s.frameEventId}i.registerEventObserver.off(a,void 0,t)},onSendResp:function(e){}};var h=function(e){this.frameObserver=e};h.prototype={onRecv:function(e,t,r,n){var i=e.data.result,a=i[0].type,o=s.copyArray(i[1]);o.unshift(a);var v=this.frameObserver.getFrameObserverList_(e.frameEventId);if(v)for(var f in v){var u=v[f];s.getContentWindowByEl(u.el)===t&&u.observer.trigger.apply(u.observer,o)}}};var p=function(e){this.frameObserver=e};p.prototype={onRecv:function(e,t,r,n){var s=this.frameObserver,i=e.data,a=i.params;s.stateManager.assign(a[0],n),u.deferredRecv().apply(this,arguments)},onSendResp:u.deferredSendResp()};var m=function(){this.evtMapping={},this.eventObservers={},this.registerEventObserver=new a,this.stateManager=new o,this.msgProcessors={method:new c(this),registerEvent:new d(this),unregisterEvent:new g(this),event:new h(this),state:new p(this)},e.addEventListener("message",this.onMessage.bind(this))};m.prototype={onMessage:function(e){var t=e.origin,r=JSON.parse(e.data),s=n(),i=e.source,a=this.msgProcessors[r.type];"send"==r.direction?a.onRecv(r,i,t,s):a.onSendResp(r,t,s)},getFrameEventId_:function(e){var r="window";return s.isElement(e)&&(r=function(r){var n=r?r:t();return s.data(e,"frameEventId",n),n}(s.data(e,"frameEventId"))),r},getFrameObserverList_:function(e){return this.eventObservers[e]?this.eventObservers[e]:this.eventObservers[e]=[]},getObserver_:function(e){var t,r=this.getFrameEventId_(e),n=this.getFrameObserverList_(r);for(var s in n)if(n[s].el===e){t=n[s].observer;break}return t||(t=new a,n.push({el:e,observer:t})),t},on:function(e,t,r){var n=this.getObserver_(e),s=this.getFrameEventId_(e);n.on(t,r),1===n.getEventNumber(t)&&this.registerEvent(e,{eventName:t,frameEventId:s})},off:function(e,t,r){var n=this.getObserver_(e),s=this.getFrameEventId_(e);n.off(t,r),0===n.getEventNumber(t)&&this.unregisterEvent(e,{eventName:t,frameEventId:s})},trigger:function(e){this.registerEventObserver.trigger(e,s.copyArray(arguments).slice(1))},callMethod:f("method"),registerEvent:f("registerEvent"),unregisterEvent:f("unregisterEvent"),registerMethods:function(e){this.methods_=e},resolveState:function(e){this.stateManager.get(e).resolve(s.copyArray(arguments).slice(1))},rejectState:function(e){this.stateManager.get(e).reject(s.copyArray(arguments).slice(1))},readyState:f("state")};var l=new m;"undefined"!=typeof e&&(e.frameObserver=l),"undefined"!=typeof module&&(module.exports=l)}(window);