//author: Sparrow.jang
//verion: 0.1.5
!function(e){var t=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},r=function(){var e,t,r=new Promise(function(r,n){t=r,e=n});r.resolve=t,r.reject=e;var n=function(e){return Array.prototype.slice.call(e,0)};return r.resolve=function(){t.call(null,n(arguments))},r.reject=function(){e.call(null,n(arguments))},r.always=function(e){r.then(function(t){e.apply(null,n(t))},function(){e.apply(null,n(val))})},r.done=function(e){r.then(function(t){e.apply(null,n(t))})},r.fail=function(e){r.then(function(){},function(t){e.apply(null,n(t))})},r},n=e.document,i=r,s="_FRAME_OBSERVER_",a={isString:function(e){return"string"==typeof e},isElement:function(e){return e instanceof Element},isObject:function(e){return"object"==typeof e},isArray:function(e){return"[object Array]"==typeof Object.prototype.toString.call(e)},clone:function(e,t,r){var n,i,s,o=this.copyArray(arguments);"boolean"!=typeof e?(n=e,s=o.slice(1)):(n=t,s=o.slice(2));for(var f in s){var i=s[f];for(var u in i)a.isArray(i[u])?n[u]=a.isArray(n[u])?n[u]:[]:a.isObject(i[u])&&(n[u]=a.isObject(n[u])?n[u]:{}),e&&a.isObject(i[u])?clone(n[u],i[u]):n[u]=i[u]}return n},copyArray:function(e){for(var t=[],r=0;r<e.length;r++)t[r]=e[r];return t},createElement:function(e){return n.createElement(e)},DATA_KEY:t(),data:function(e,t,r){var n=this.DATA_KEY,i=e[n]?e[n]:e[n]={};return 3!==arguments.length?i[t]:void(i[t]=r)},getContentWindowByEl:function(e){return a.isElement(e)?e.contentWindow:e},postMessage:function(e,t,r){e.postMessage(JSON.stringify(t),r)}},o={getOrigin:function(e){var t=/https?:\/\/[^\/]*\/?/.exec(e);return t.length?t[0]:null},getOriginByFrameEl:function(e){return a.isElement(e)?o.getOrigin(e.src):document.referrer}},f=function(){this.events={}};f.prototype={on:function(e,t,r){var r=r||{};this.events[e]||(this.events[e]=[]),this.events[e].push({func:t,once:r.once||!1,target:r.target||null})},once:function(e,t){this.on(e,t,{once:!0})},off:function(e,t,r){var n=this.events[e]||[];if(1===arguments.length)delete this.events[e];else for(var i in n){var s=n[i];if(s.func===t&&(null===s.target||s.target===r)||void 0===t&&s.target===r){n.splice(i,1);break}}},getEventNumber:function(e){return this.events[e]?this.events[e].length:0},trigger:function(e){var t,r,n=+new Date;a.isString(e)?t=e:(t=e.name,r=e.target||null);var i,s=this.events[t]||[],o=a.copyArray(arguments);r&&(s=function(e,t){var r=[];for(var n in e)e[n].target===t&&r.push(e[n]);return r}(s,r));for(i in s){var f={type:t,timeStamp:n},u=o.slice(1);u.unshift(f),s[i].func.apply(null,u)}for(i=0;i<s.length;i++)s[i].once&&(r?this.off(t,e.func,e.target):this.off(t,e.func))}};var u=function(){this.stateDeferredMap={}};u.prototype={assign:function(e,t){var r=this.get(e);r.done(t.resolve.bind(t)),r.fail(t.reject.bind(t))},get:function(e){var t=this.stateDeferredMap[e];return t?t:this.stateDeferredMap[e]=i()}};var v=function(e,r,n,i,o){var f=n||{},u=i?i:t(),v=o||{},c={};return c[s]=!0,a.clone({type:e,data:f,id:u,timestamp:+new Date,direction:r},v,c)},c=function(e,t){return function(r){var n,s,f=i(),u=v(e,"send",{params:a.copyArray(arguments).slice(1)},null,t);return this.evtMapping[u.id]={el:r,id:u.id,deferred:f},n=o.getOriginByFrameEl(r),s=a.getContentWindowByEl(r),a.postMessage(s,u,n),f}},d={deferredSendResp:function(){return function(e){var t="reject",r=this.frameObserver,n=r.evtMapping[e.id];delete r.evtMapping[e.id],"done"===e.deferredState&&(t="resolve"),n.deferred[t](e.data)}},deferredRecv:function(){return function(e,t,r,n){var i=function(n){return function(){var i=v(e.type,"recv",{result:arguments},e.id,{deferredState:n});a.postMessage(t,i,r)}};n.done(i("done")),n.fail(i("fail"))}}},g=function(e){this.frameObserver=e};g.prototype={onRecv:function(e,t,r,n){var i=this.frameObserver,s=e.data.params,a=s.shift();s.unshift(n),i.methods_&&i.methods_[a]?i.methods_[a].apply(i.methods_,s):n.reject({err:"the method is not exist."}),d.deferredRecv().apply(this,arguments)},onSendResp:d.deferredSendResp()};var l=function(e){this.frameObserver=e};l.prototype={onRecv:function(e,t,r,n){var i=e.data.params[0],s=this.frameObserver,o=i.eventName,f=i.frameEventId;s.registerEventObserver.on(o,function(){var n=v("event","send",{result:a.copyArray(arguments)},e.id);n.frameEventId=f,a.postMessage(t,n,r)},{target:t})},onSendResp:function(e){}};var p=function(e){this.frameObserver=e};p.prototype={onRecv:function(e,t,r,n){{var i=e.data.params[0],s=this.frameObserver,a=i.eventName;i.frameEventId}s.registerEventObserver.off(a,void 0,t)},onSendResp:function(e){}};var h=function(e){this.frameObserver=e};h.prototype={onRecv:function(e,t,r,n){var i=e.data.result,s=i[0].type,o=a.copyArray(i[1]);o.unshift(s);var f=this.frameObserver.getFrameObserverList_(e.frameEventId);if(f)for(var u in f){var v=f[u];a.getContentWindowByEl(v.el)===t&&v.observer.trigger.apply(v.observer,o)}}};var m=function(e){this.frameObserver=e};m.prototype={onRecv:function(e,t,r,n){var i=this.frameObserver,s=e.data,a=s.params;i.stateManager.assign(a[0],n),d.deferredRecv().apply(this,arguments)},onSendResp:d.deferredSendResp()};var y=function(){this.evtMapping={},this.eventObservers={},this.registerEventObserver=new f,this.stateManager=new u,this.methods_={},this.msgProcessors={method:new g(this),registerEvent:new l(this),unregisterEvent:new p(this),event:new h(this),state:new m(this)},e.addEventListener("message",this.onMessage.bind(this))};y.prototype={onMessage:function(e){var t,r=e.origin;try{t=JSON.parse(e.data)}catch(n){t=null}if(a.isObject(t)&&s in t){var o=i(),f=e.source,u=this.msgProcessors[t.type];"send"==t.direction?u.onRecv(t,f,r,o):u.onSendResp(t,r,o)}},getFrameEventId_:function(e){var r="window";return a.isElement(e)&&(r=function(r){var n=r?r:t();return a.data(e,"frameEventId",n),n}(a.data(e,"frameEventId"))),r},getFrameObserverList_:function(e){return this.eventObservers[e]?this.eventObservers[e]:this.eventObservers[e]=[]},getObserver_:function(e){var t,r=this.getFrameEventId_(e),n=this.getFrameObserverList_(r);for(var i in n)if(n[i].el===e){t=n[i].observer;break}return t||(t=new f,n.push({el:e,observer:t})),t},on:function(e,t,r){var n=this.getObserver_(e),i=this.getFrameEventId_(e);n.on(t,r),1===n.getEventNumber(t)&&this.registerEvent(e,{eventName:t,frameEventId:i})},off:function(e,t,r){var n=this.getObserver_(e),i=this.getFrameEventId_(e);n.off(t,r),0===n.getEventNumber(t)&&this.unregisterEvent(e,{eventName:t,frameEventId:i})},trigger:function(e){this.registerEventObserver.trigger(e,a.copyArray(arguments).slice(1))},callMethod:c("method"),registerEvent:c("registerEvent"),unregisterEvent:c("unregisterEvent"),registerMethods:function(e){for(var t in e)this.methods_[t]=e[t]},resolveState:function(e){this.stateManager.get(e).resolve(a.copyArray(arguments).slice(1))},rejectState:function(e){this.stateManager.get(e).reject(a.copyArray(arguments).slice(1))},readyState:c("state")};var b=new y;"undefined"!=typeof e&&(e.frameObserver=b),"undefined"!=typeof module&&(module.exports=b)}(window);